/*
    This file is part of the Vector Generator project for drawing analogue
    graphics on X/Y oscilloscopes.

    Copyright (C) 2018-2022 Toby Thain, toby@telegraphics.com.au

    This program is free software; you can redistribute it and/or modify
    it under the terms of the GrenNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
*/

#include "display_list.h"

#define ON 0x80u
#define ENDCHAR 0xffu
uint8_t font1[] = {
		// cell is 6 wide by 10 high. baseline is y=2
		// first byte, starting position
		// subsequent bytes until 0: new position. ON = beam on
		' ', 0x00, ENDCHAR,
		'A', 0x02, ON|0x07, ON|0x3a, ON|0x67, ON|0x62, 0x05, ON|0x65, ENDCHAR,
		'B', 0x02, ON|0x52, ON|0x64, ON|0x56, ON|0x68, ON|0x5a, ON|0x0a, ON|0x02, 0x06, ON|0x56, ENDCHAR,
		'C', 0x64, ON|0x52, ON|0x12, ON|0x04, ON|0x08, ON|0x1a, ON|0x5a, ON|0x68, ENDCHAR,
		'D', 0x12, ON|0x1a, ON|0x4a, ON|0x68, ON|0x64, ON|0x42, ON|0x12, ENDCHAR,
		'E', 0x62, ON|0x02, ON|0x0a, ON|0x6a, 0x06, ON|0x56, ENDCHAR,
		'F', 0x02, ON|0x0a, ON|0x6a, 0x06, ON|0x56, ENDCHAR,
		'G', 0x35, ON|0x65, ON|0x52, ON|0x12, ON|0x04, ON|0x08, ON|0x1a, ON|0x5a, ON|0x68, ENDCHAR,
		'H', 0x02, ON|0x0a, 0x06, ON|0x66, 0x62, ON|0x6a, ENDCHAR,
		'I', 0x22, ON|0x42, 0x32, ON|0x3a, 0x2a, ON|0x4a, ENDCHAR,
		'J', 0x13, ON|0x22, ON|0x42, ON|0x54, ON|0x5a, ON|0x3a, ENDCHAR,
		'K', 0x12, ON|0x1a, 0x6a, ON|0x26, ON|0x62, ENDCHAR,
		'L', 0x62, ON|0x12, ON|0x1a, ENDCHAR,
		'M', 0x02, ON|0x0a, ON|0x35, ON|0x6a, ON|0x62, ENDCHAR,
		'N', 0x02, ON|0x0a, ON|0x52, ON|0x5a, ENDCHAR,
		'O', 0x12, ON|0x52, ON|0x64, ON|0x68, ON|0x5a, ON|0x1a, ON|0x08, ON|0x04, ON|0x12, ENDCHAR,
		'P', 0x12, ON|0x1a, ON|0x5a, ON|0x68, ON|0x67, ON|0x55, ON|0x15, ENDCHAR,
		'Q', 0x12, ON|0x52, ON|0x64, ON|0x68, ON|0x5a, ON|0x1a, ON|0x08, ON|0x04, ON|0x12, 0x34, ON|0x50, ENDCHAR,
		'R', 0x12, ON|0x1a, ON|0x5a, ON|0x68, ON|0x67, ON|0x55, ON|0x15, 0x55, ON|0x72, ENDCHAR,
		'S', 0x12, ON|0x52, ON|0x64, ON|0x56, ON|0x16, ON|0x08, ON|0x1a, ON|0x5a, ENDCHAR,
		'T', 0x32, ON|0x3a, 0x0a, ON|0x6a, ENDCHAR,
		'U', 0x0a, ON|0x04, ON|0x12, ON|0x42, ON|0x54, ON|0x5a, ENDCHAR,
		'V', 0x0a, ON|0x32, ON|0x6a, ENDCHAR,
		'W', 0x0a, ON|0x12, ON|0x37, ON|0x52, ON|0x6a, ENDCHAR,
		'X', 0x02, ON|0x6a, 0x0a, ON|0x62, ENDCHAR,
		'Y', 0x0a, ON|0x35, ON|0x6a, 0x35, ON|0x32, ENDCHAR,
		'Z', 0x0a, ON|0x5a, ON|0x02, ON|0x52, ENDCHAR,
		'0', 0x12, ON|0x42, ON|0x55, ON|0x57, ON|0x4a, ON|0x1a, ON|0x07, ON|0x05, ON|0x12, ENDCHAR,
		'1', 0x32, ON|0x3a, ON|0x07, ENDCHAR,
		'2', 0x52, ON|0x02, ON|0x57, ON|0x4a, ON|0x1a, ON|0x08, ENDCHAR,
		'3', 0x03, ON|0x32, ON|0x53, ON|0x46, ON|0x16, 0x46, ON|0x59, ON|0x3a, ON|0x09, ENDCHAR,
		'4', 0x42, ON|0x4a, ON|0x04, ON|0x54, ENDCHAR,
		'5', 0x03, ON|0x22, ON|0x42, ON|0x54, ON|0x46, ON|0x06, ON|0x0a, ON|0x4a, ENDCHAR,
		'6', 0x4a, ON|0x1a, ON|0x07, ON|0x05, ON|0x12, ON|0x42, ON|0x54, ON|0x47, ON|0x06, ENDCHAR,
		'7', 0x22, ON|0x5a, ON|0x0a, ENDCHAR,
		'8', 0x12, ON|0x42, ON|0x54, ON|0x46, ON|0x58, ON|0x4a, ON|0x1a, ON|0x08, ON|0x16, ON|0x46, 0x16, ON|0x04, ON|0x12, ENDCHAR,
		'9', 0x12, ON|0x42, ON|0x55, ON|0x57, ON|0x4a, ON|0x1a, ON|0x08, ON|0x15, ON|0x56, ENDCHAR,
		'.', 0x32, ON|0x32, ENDCHAR,
		'\'', 0x3a, ON|0x27, ENDCHAR,
		':', 0x33, ON|0x43, 0x37, ON|0x47, ENDCHAR
};

uint8_t seven_segment_font[] = {
		' ', 0x00, ENDCHAR,
		'0', 0x03, ON|0x06, 0x08, ON|0x0b, 0x1c, ON|0x4c, 0x5b, ON|0x58, 0x56, ON|0x53, 0x42, ON|0x12, ENDCHAR,
		'1', 0x5b, ON|0x58, 0x56, ON|0x53, ENDCHAR,
		'2', 0x03, ON|0x06, 0x1c, ON|0x4c, 0x5b, ON|0x58, 0x42, ON|0x12, 0x17, ON|0x47, ENDCHAR,
		'3', 0x1c, ON|0x4c, 0x5b, ON|0x58, 0x56, ON|0x53, 0x42, ON|0x12, 0x17, ON|0x47, ENDCHAR,
		'4', 0x08, ON|0x0b, 0x5b, ON|0x58, 0x56, ON|0x53, 0x17, ON|0x47, ENDCHAR,
		'5', 0x08, ON|0x0b, 0x1c, ON|0x4c, 0x56, ON|0x53, 0x42, ON|0x12, 0x17, ON|0x47, ENDCHAR,
		'6', 0x03, ON|0x06, 0x08, ON|0x0b, 0x1c, ON|0x4c, 0x56, ON|0x53, 0x42, ON|0x12, 0x17, ON|0x47, ENDCHAR,
		'7', 0x1c, ON|0x4c, 0x5b, ON|0x58, 0x56, ON|0x53, ENDCHAR,
		'8', 0x03, ON|0x06, 0x08, ON|0x0b, 0x1c, ON|0x4c, 0x5b, ON|0x58, 0x56, ON|0x53, 0x42, ON|0x12, 0x17, ON|0x47, ENDCHAR,
		'9', 0x08, ON|0x0b, 0x1c, ON|0x4c, 0x5b, ON|0x58, 0x56, ON|0x53, 0x42, ON|0x12, 0x17, ON|0x47, ENDCHAR,
		'A', 0x03, ON|0x06, 0x08, ON|0x0b, 0x1c, ON|0x4c, 0x5b, ON|0x58, 0x56, ON|0x53, 0x17, ON|0x47, ENDCHAR,
		'B', 0x03, ON|0x06, 0x08, ON|0x0b, 0x56, ON|0x53, 0x42, ON|0x12, 0x17, ON|0x47, ENDCHAR,
		'C', 0x03, ON|0x06, 0x08, ON|0x0b, 0x1c, ON|0x4c, 0x42, ON|0x12, ENDCHAR,
		'D', 0x03, ON|0x06, 0x5b, ON|0x58, 0x56, ON|0x53, 0x42, ON|0x12, 0x17, ON|0x47, ENDCHAR,
		'E', 0x03, ON|0x06, 0x08, ON|0x0b, 0x1c, ON|0x4c, 0x42, ON|0x12, 0x17, ON|0x47, ENDCHAR,
		'F', 0x03, ON|0x06, 0x08, ON|0x0b, 0x1c, ON|0x4c, 0x17, ON|0x47, ENDCHAR,
		'-', 0x17, ON|0x47, ENDCHAR,
		'.', 0x32, ON|0x32, ENDCHAR,
};

uint8_t *current_font;
uint16_t charmap[0x80];

void index_chardata(uint8_t chardata[], size_t font_bytes) {
	uint16_t i = 0;
    while(i < font_bytes) {
    	charmap[ chardata[i] ] = i;
    	++i; // skip character marker
    	while(i < font_bytes && chardata[i] != ENDCHAR)
    		++i;
    	++i; // skip endchar marker
    }
    current_font = chardata;
}

unsigned setup_text(unsigned idx, int x, int y, int scale, char *s) {
	int lastx, lasty;
	for(uint8_t *pc = (uint8_t*)s; *pc && idx < DISPLAY_LIST_MAX; ++pc) {
		uint8_t *p;
		unsigned i;

		for(i = 0, p = current_font + charmap[*pc] + 1 ; *p != ENDCHAR ; ++p, ++i) {
			int posx = x + scale*((*p & 0x70) >> 4),
				posy = y + scale*(*p & 0x0f);
			if(i && (*p & ON)) {
				// Note: improve quality at small text sizes using `slow` flag
				setup_line_int(idx++, lastx, lasty, posx, posy, 0, MAX_Z_LEVEL, scale < 40);
			}
			lastx = posx;
			lasty = posy;
		}
		x += scale*9; // advance to the right by one character position
	}
	return idx;
}
